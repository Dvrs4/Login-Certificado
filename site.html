<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gerenciador de Certificados (Atualizado)</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<!-- SheetJS for Excel export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
/* ---------- Estilos (compactados, iguais à versão anterior) ---------- */
:root{--primary:#2c3e50;--secondary:#3498db;--success:#2ecc71;--warning:#f39c12;--danger:#e74c3c;--light:#ecf0f1;--dark:#34495e;--gray:#95a5a6;--card-bg:#fff}
*{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
body{background:#f5f7fa;color:#222;min-height:100vh}
.container{max-width:1400px;margin:20px auto;padding:16px}
header{background:var(--primary);color:#fff;padding:16px;border-radius:8px;display:flex;align-items:center;justify-content:space-between;gap:12px}
.logo{font-size:20px;font-weight:700}
.header-actions{display:flex;align-items:center;gap:12px;position:relative}
.notification-icon{position:relative;cursor:pointer}
.notification-badge{background:var(--danger);color:#fff;border-radius:50%;width:22px;height:22px;display:flex;align-items:center;justify-content:center;font-size:12px;position:absolute;top:-8px;right:-8px}
.main-content{display:flex;gap:20px;margin-top:20px}
.sidebar{flex:0 0 300px;background:var(--card-bg);padding:16px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
.content{flex:1;background:var(--card-bg);padding:16px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
.filters h3{margin-bottom:12px;border-bottom:1px solid #eee;padding-bottom:8px}
.filter-group{margin-bottom:12px}
.filter-group label{display:block;margin-bottom:6px;font-weight:600}
.filter-group select,.filter-group input{width:100%;padding:8px;border:1px solid #ddd;border-radius:6px}
.certificates-table{width:100%;border-collapse:collapse;margin-top:8px}
.certificates-table th,.certificates-table td{padding:10px 12px;text-align:left;border-bottom:1px solid #eee;font-size:14px}
.certificates-table th{background:#fafafa;font-weight:700}
.status-badge{padding:6px 10px;border-radius:20px;font-weight:600;font-size:13px}
.status-no-prazo{background:#e8f5e9;color:#2e7d32}
.status-a-vencer{background:#fff8e1;color:#f57c00}
.status-vencido{background:#ffebee;color:#d32f2f}
.actions{display:flex;gap:8px}
.action-btn{background:none;border:none;cursor:pointer;color:var(--dark);font-size:16px}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);justify-content:center;align-items:center;z-index:1000;padding:16px}
.modal-content{background:#fff;padding:18px;border-radius:8px;width:600px;max-width:100%;max-height:90vh;overflow:auto}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;border-bottom:1px solid #eee;padding-bottom:8px}
.close{cursor:pointer;font-size:20px}
.upload-area{border:2px dashed var(--gray);border-radius:8px;padding:20px;text-align:center;cursor:pointer}
.upload-area .upload-icon{font-size:36px;color:var(--gray);margin-bottom:8px}
.notification-panel{display:none;position:absolute;top:56px;right:16px;width:360px;background:#fff;border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,0.12);z-index:120}
.notification-header{padding:12px;border-bottom:1px solid #eee;font-weight:700;display:flex;justify-content:space-between;align-items:center}
.notification-list{max-height:320px;overflow:auto}
.notification-item{padding:12px;border-bottom:1px solid #f0f0f0;font-size:14px}
.notification-empty{padding:12px}
.pagination{display:flex;gap:8px;justify-content:center;margin-top:12px;flex-wrap:wrap}
.page-btn{padding:8px 12px;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer}
.page-btn.active{background:var(--secondary);color:#fff;border-color:var(--secondary)}
@media(max-width:900px){.main-content{flex-direction:column}.sidebar{order:2}.content{order:1}.certificates-table{display:none}.card-list{display:block}.card-item{background:#fff;padding:12px;border-radius:8px;margin-bottom:12px;box-shadow:0 4px 14px rgba(0,0,0,0.04)}.info-row{display:flex;gap:8px;margin-bottom:6px}.info-label{font-weight:700;width:110px}}
@media(min-width:901px){.card-list{display:none}}
.form-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
.btn{padding:8px 12px;border-radius:6px;border:none;cursor:pointer}
.btn-primary{background:var(--secondary);color:#fff}
.btn-warning{background:var(--warning);color:#fff}
.btn-danger{background:var(--danger);color:#fff}
.btn-success{background:var(--success);color:#fff}
.small{font-size:13px;color:#666}
.service-worker-status{margin-top:8px;padding:8px;border-radius:6px;font-size:13px}
.status-active{background:#e8f5e9;color:#2e7d32}
.status-inactive{background:#ffebee;color:#d32f2f}
.hidden{display:none}
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="logo"><i class="fas fa-certificate"></i> Gerenciador de Certificados</div>
    <div class="header-actions">
      <div class="notification-icon" id="notificationIcon" title="Notificações">
        <i class="fas fa-bell fa-lg" style="color:#fff"></i>
        <span class="notification-badge" id="notificationCount">0</span>
      </div>
      <button class="btn btn-primary" id="addCertificateBtn"><i class="fas fa-plus"></i> Adicionar</button>
    </div>
  </header>

  <div class="notification-panel" id="notificationPanel" aria-hidden="true">
    <div class="notification-header">
      <span>Notificações</span>
      <div>
        <button class="btn" id="clearNotificationsBtn" title="Limpar"><i class="fas fa-trash"></i></button>
      </div>
    </div>
    <div class="notification-list" id="notificationList"></div>
  </div>

  <div class="main-content">
    <aside class="sidebar" aria-label="Filtros e configurações">
      <div class="filters">
        <h3>Filtros</h3>
        <div class="filter-group"><label for="statusFilter">Status</label>
          <select id="statusFilter"><option value="all">Todos</option><option value="no-prazo">No prazo</option><option value="a-vencer">À vencer</option><option value="vencido">Vencido</option></select>
        </div>
        <div class="filter-group"><label for="ufFilter">UF</label>
          <select id="ufFilter"><option value="all">Todos</option><option value="SP">SP</option><option value="RJ">RJ</option><option value="MG">MG</option></select>
        </div>
        <div class="filter-group"><label for="searchFilter">CNPJ/CPF ou Nome</label>
          <input type="text" id="searchFilter" placeholder="Buscar..."></div>
        <button class="btn btn-primary" id="applyFilters" style="width:100%">Aplicar Filtros</button>
      </div>

      <div style="margin-top:16px">
        <h3>Notificações</h3>
        <div class="setting-group small" style="margin-bottom:8px"><label><input type="checkbox" id="browserNotifications" checked> Notificações do Navegador</label></div>
        <div class="setting-group small" style="margin-bottom:8px"><label><input type="checkbox" id="systemNotifications"> Notificações do Sistema (Push)</label></div>
        <div class="setting-group"><label for="notificationDays">Avisar antes (dias)</label>
          <select id="notificationDays"><option value="1">1</option><option value="3">3</option><option value="7" selected>7</option><option value="15">15</option><option value="30">30</option></select>
        </div>
        <button class="btn btn-warning" id="testNotificationBtn" style="width:100%;margin-top:8px"><i class="fas fa-bell"></i> Testar</button>
        <div id="serviceWorkerStatus" class="service-worker-status status-inactive">Service Worker: Não ativo</div>

        <hr style="margin:12px 0">

        <h3>Export / Import</h3>
        <div style="display:flex;gap:8px;flex-direction:column">
          <button id="exportExcelBtn" class="btn btn-success"><i class="fas fa-file-excel"></i> Exportar Excel</button>
          <button id="importBatchBtn" class="btn btn-warning"><i class="fas fa-folder-open"></i> Importar em Lote (pasta)</button>
        </div>

        <hr style="margin:12px 0">

        <h3>Paginação</h3>
        <div style="display:flex;gap:8px;align-items:center">
          <label class="small">Itens / pág</label>
          <select id="pageSizeSelect"><option value="5">5</option><option value="10" selected>10</option><option value="25">25</option><option value="50">50</option></select>
        </div>
      </div>

    </aside>

    <main class="content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <h2>Certificados Cadastrados</h2>
        <div style="display:flex;gap:8px;align-items:center">
          <input type="text" id="searchInput" placeholder="Buscar certificado..." style="padding:8px;border:1px solid #ddd;border-radius:6px">
          <button class="btn btn-primary" id="searchBtn"><i class="fas fa-search"></i></button>
        </div>
      </div>

      <table class="certificates-table" aria-label="Tabela de certificados">
        <thead><tr><th><input type="checkbox" id="selectAll"></th>
            <th>Nome</th><th>CNPJ/CPF</th><th>UF</th><th>Vencimento</th><th>Status</th><th>Consulta Noturna</th><th>Manifestar</th><th>Tipos</th><th>Saída</th><th>Último Update</th><th>Ações</th>
        </tr></thead>
        <tbody id="certificatesTableBody"></tbody>
      </table>

      <div class="card-list" id="cardList"></div>
      <div class="pagination" id="pagination"></div>
    </main>
  </div>
</div>

<!-- Modals (idem versão anterior) -->
<div class="modal" id="uploadModal" role="dialog">
  <div class="modal-content"><div class="modal-header"><h3>Adicionar Certificado</h3><span class="close" id="closeUploadModal">&times;</span></div>
  <div class="upload-area" id="certificateUpload"><div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div><p>Clique ou arraste o arquivo (.pfx .p12 .cer .crt .pem)</p><input type="file" id="certificateFile" accept=".pfx,.p12,.cer,.crt,.pem" style="display:none"></div>
  <div class="form-actions"><button class="btn" id="cancelUploadBtn">Cancelar</button></div></div>
</div>

<div class="modal" id="certificateInfoModal" role="dialog">
  <div class="modal-content"><div class="modal-header"><h3>Informações do Certificado</h3><span class="close" id="closeInfoModal">&times;</span></div>
  <div id="certificateInfo" style="margin-bottom:12px"></div>
  <form id="certificateForm">
    <div class="form-group" style="margin-bottom:8px"><label for="certificateName">Nome</label><input type="text" id="certificateName" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px"></div>
    <div class="form-group" style="margin-bottom:8px"><label for="certificateCnpjCpf">CNPJ/CPF</label><input type="text" id="certificateCnpjCpf" placeholder="000.000.000-00 ou 00.000.000/0000-00" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px"></div>
    <div class="form-group" style="margin-bottom:8px"><label for="certificateUf">UF</label>
      <select id="certificateUf" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px"><option value="">Selecione</option>
        <option value="AC">AC</option><option value="AL">AL</option><option value="AM">AM</option><option value="AP">AP</option><option value="BA">BA</option><option value="CE">CE</option><option value="DF">DF</option><option value="ES">ES</option><option value="GO">GO</option><option value="MA">MA</option><option value="MG">MG</option><option value="MS">MS</option><option value="MT">MT</option><option value="PA">PA</option><option value="PB">PB</option><option value="PE">PE</option><option value="PI">PI</option><option value="PR">PR</option><option value="RJ">RJ</option><option value="RN">RN</option><option value="RO">RO</option><option value="RR">RR</option><option value="RS">RS</option><option value="SC">SC</option><option value="SE">SE</option><option value="SP">SP</option><option value="TO">TO</option>
      </select>
    </div>
    <div class="form-group" style="margin-bottom:8px"><label for="certificateExpiry">Data de Vencimento</label><input type="date" id="certificateExpiry" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px"></div>
    <div class="form-actions"><button type="button" class="btn" id="cancelInfoBtn">Cancelar</button><button type="submit" class="btn btn-primary">Confirmar</button></div>
  </form></div>
</div>

<div class="modal" id="deleteModal" role="dialog">
  <div class="modal-content"><div class="modal-header"><h3>Excluir Certificado</h3><span class="close" id="closeDeleteModal">&times;</span></div>
  <p>Tem certeza que deseja excluir o certificado <strong id="deleteCertificateName"></strong>?</p>
  <div class="form-actions"><button class="btn" id="cancelDeleteBtn">Cancelar</button><button class="btn btn-danger" id="confirmDeleteBtn">Excluir</button></div></div>
</div>

<div style="text-align:center;margin:12px;font-size:12px;color:#666">Sistema desenvolvido por Davi Vieira</div>

<script>
/* =========================
   Código JavaScript completo
   ========================= */

/* ---------- Dados / estado ---------- */
let certificatesData = JSON.parse(localStorage.getItem('certificates')) || [
  { id: 1, name: "AR VARGAS CONSULTORIA EMPRESARIAL LTDA", cnpjCpf: "06171078000123", uf: "TO", expiry: "2025-08-23", status: "vencido", nightQuery: "Desativada", manifest: "Não", fileTypes: "NFe/CTe", outputConfig: "Não", lastUpdate: "23/08/2024 19:51", fileData: null },
  { id: 2, name: "ELO5 AGRONEGOCIOS LTDA", cnpjCpf: "07203700000160", uf: "TO", expiry: "2026-06-23", status: "no-prazo", nightQuery: "Desativada", manifest: "Não", fileTypes: "NFe/CTe", outputConfig: "Sim", lastUpdate: "23/06/2025 20:16", fileData: null }
];
let notifications = JSON.parse(localStorage.getItem('notifications')) || [];
let notificationSettings = JSON.parse(localStorage.getItem('notificationSettings')) || { browserNotifications:true, systemNotifications:false, notificationDays:7 };
let serviceWorkerRegistration = null;
let currentPage = 1;
let pageSize = parseInt(localStorage.getItem('pageSize')) || 10;
let currentCertificate = null;
let currentFile = null;

/* ---------- DOM ---------- */
const certificatesTableBody = document.getElementById('certificatesTableBody');
const cardList = document.getElementById('cardList');
const notificationList = document.getElementById('notificationList');
const notificationCount = document.getElementById('notificationCount');
const notificationIcon = document.getElementById('notificationIcon');
const notificationPanel = document.getElementById('notificationPanel');
const addCertificateBtn = document.getElementById('addCertificateBtn');
const uploadModal = document.getElementById('uploadModal');
const closeUploadModal = document.getElementById('closeUploadModal');
const cancelUploadBtn = document.getElementById('cancelUploadBtn');
const certificateUpload = document.getElementById('certificateUpload');
const certificateFile = document.getElementById('certificateFile');
const certificateInfoModal = document.getElementById('certificateInfoModal');
const closeInfoModal = document.getElementById('closeInfoModal');
const cancelInfoBtn = document.getElementById('cancelInfoBtn');
const certificateForm = document.getElementById('certificateForm');
const certificateInfo = document.getElementById('certificateInfo');
const deleteModal = document.getElementById('deleteModal');
const closeDeleteModal = document.getElementById('closeDeleteModal');
const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
const deleteCertificateName = document.getElementById('deleteCertificateName');
const applyFilters = document.getElementById('applyFilters');
const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const statusFilter = document.getElementById('statusFilter');
const ufFilter = document.getElementById('ufFilter');
const searchFilter = document.getElementById('searchFilter');
const selectAll = document.getElementById('selectAll');
const browserNotifications = document.getElementById('browserNotifications');
const systemNotifications = document.getElementById('systemNotifications');
const notificationDays = document.getElementById('notificationDays');
const testNotificationBtn = document.getElementById('testNotificationBtn');
const serviceWorkerStatus = document.getElementById('serviceWorkerStatus');
const pageSizeSelect = document.getElementById('pageSizeSelect');
const pagination = document.getElementById('pagination');
const clearNotificationsBtn = document.getElementById('clearNotificationsBtn');
const exportExcelBtn = document.getElementById('exportExcelBtn');
const importBatchBtn = document.getElementById('importBatchBtn');

/* ---------- Inicialização ---------- */
function init(){
  loadNotificationSettings();
  pageSizeSelect.value = String(pageSize);
  attachEventListeners();
  checkExpiryDates();
  renderNotifications();
  renderCurrentPage();
  initServiceWorker();
  startNotificationChecker();
}
init();

/* ---------- Render / Paginação ---------- */
function renderCurrentPage(){
  const filtered = applyCurrentFiltersTo(certificatesData);
  const total = filtered.length;
  const totalPages = Math.max(1, Math.ceil(total / pageSize));
  if(currentPage > totalPages) currentPage = totalPages;
  const start = (currentPage - 1) * pageSize;
  const pageItems = filtered.slice(start, start + pageSize);
  renderTable(pageItems);
  renderCards(pageItems);
  renderPagination(totalPages);
}

function renderTable(items){
  certificatesTableBody.innerHTML = '';
  if(items.length === 0){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="12" style="text-align:center;padding:18px">Nenhum certificado</td>`;
    certificatesTableBody.appendChild(tr);
    return;
  }
  const frag = document.createDocumentFragment();
  items.forEach(cert => {
    const statusClass = cert.status === 'no-prazo' ? 'status-no-prazo' : (cert.status === 'a-vencer' ? 'status-a-vencer' : 'status-vencido');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="checkbox" class="certificate-checkbox" data-id="${cert.id}"></td>
      <td>${escapeHtml(cert.name)}</td>
      <td>${formatCnpjCpfDisplay(cert.cnpjCpf)}</td>
      <td>${cert.uf || ''}</td>
      <td>${formatDate(cert.expiry)}</td>
      <td><span class="status-badge ${statusClass}">${cert.status === 'no-prazo'?'No Prazo':cert.status === 'a-vencer'?'À Vencer':'Vencido'}</span></td>
      <td>${cert.nightQuery}</td><td>${cert.manifest}</td><td>${cert.fileTypes}</td><td>${cert.outputConfig}</td>
      <td>${cert.lastUpdate}</td>
      <td class="actions">
        <button class="action-btn" title="Editar" onclick="editCertificate(${cert.id})"><i class="fas fa-edit"></i></button>
        <button class="action-btn" title="Excluir" onclick="showDeleteModal(${cert.id})"><i class="fas fa-trash"></i></button>
        <button class="action-btn" title="Baixar" onclick="downloadCertificate(${cert.id})"><i class="fas fa-download"></i></button>
      </td>
    `;
    frag.appendChild(tr);
  });
  certificatesTableBody.appendChild(frag);
}

function renderCards(items){
  cardList.innerHTML = '';
  if(items.length === 0) return;
  const frag = document.createDocumentFragment();
  items.forEach(cert=>{
    const div = document.createElement('div');
    div.className = 'card-item';
    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <strong>${escapeHtml(cert.name)}</strong>
        <span class="small">${formatDate(cert.expiry)}</span>
      </div>
      <div class="info-row"><div class="info-label">CNPJ/CPF:</div><div class="info-value">${formatCnpjCpfDisplay(cert.cnpjCpf)}</div></div>
      <div class="info-row"><div class="info-label">UF:</div><div class="info-value">${cert.uf}</div></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" onclick="editCertificate(${cert.id})">Editar</button>
        <button class="btn btn-danger" onclick="showDeleteModal(${cert.id})">Excluir</button>
      </div>
    `;
    frag.appendChild(div);
  });
  cardList.appendChild(frag);
}

function renderPagination(totalPages){
  pagination.innerHTML = '';
  if(totalPages <= 1) return;
  const prev = document.createElement('button'); prev.className='page-btn'; prev.innerHTML='<i class="fas fa-chevron-left"></i>';
  prev.onclick = ()=>{ if(currentPage>1){currentPage--; renderCurrentPage();} };
  pagination.appendChild(prev);
  for(let p=1;p<=totalPages;p++){
    const btn = document.createElement('button'); btn.className='page-btn'+(p===currentPage? ' active':''); btn.textContent=p;
    btn.onclick = ()=>{ currentPage=p; renderCurrentPage(); };
    pagination.appendChild(btn);
  }
  const next = document.createElement('button'); next.className='page-btn'; next.innerHTML='<i class="fas fa-chevron-right"></i>';
  next.onclick = ()=>{ if(currentPage<totalPages){currentPage++; renderCurrentPage();} };
  pagination.appendChild(next);
}

/* ---------- Filtros ---------- */
function applyCurrentFiltersTo(list){
  const statusValue = statusFilter.value;
  const ufValue = ufFilter.value;
  const searchValue = (searchFilter.value || '').trim().toLowerCase();
  const searchInputValue = (searchInput.value || '').trim().toLowerCase();
  return list.filter(c=>{
    if(statusValue!=='all' && c.status !== statusValue) return false;
    if(ufValue!=='all' && c.uf !== ufValue) return false;
    if(searchValue){
      if(!c.name.toLowerCase().includes(searchValue) && !String(c.cnpjCpf).includes(searchValue)) return false;
    }
    if(searchInputValue){
      if(!c.name.toLowerCase().includes(searchInputValue) && !String(c.cnpjCpf).includes(searchInputValue)) return false;
    }
    return true;
  });
}

/* ---------- Notificações e validade ---------- */
function checkExpiryDates(){
  notifications = [];
  const today = new Date();
  const daysToNotify = parseInt(notificationSettings.notificationDays) || 7;
  certificatesData.forEach(c=>{
    const expiryDate = new Date(c.expiry);
    const daysUntil = Math.floor((expiryDate - today)/(1000*60*60*24));
    if(daysUntil < 0){
      notifications.push({ id:c.id, message:`Certificado ${c.name} está vencido`, type:'danger', date: formatDateISO(today) });
      c.status = 'vencido';
      if(notificationSettings.browserNotifications) sendBrowserNotification('Certificado Vencido', `O certificado ${c.name} está vencido!`);
    } else if(daysUntil <= daysToNotify){
      notifications.push({ id:c.id, message:`Certificado ${c.name} vence em ${daysUntil} dias`, type:'warning', date: formatDateISO(today) });
      if(c.status !== 'a-vencer') c.status = 'a-vencer';
      if(notificationSettings.browserNotifications && daysUntil <= 7) sendBrowserNotification('Vencimento Próximo', `O certificado ${c.name} vence em ${daysUntil} dias`);
    } else {
      c.status = 'no-prazo';
    }
  });
  localStorage.setItem('certificates', JSON.stringify(certificatesData));
  localStorage.setItem('notifications', JSON.stringify(notifications));
  renderNotifications();
  renderCurrentPage();
}

function renderNotifications(){
  notificationList.innerHTML = '';
  notificationCount.textContent = String(notifications.length || 0);
  if(notifications.length === 0){
    const div = document.createElement('div'); div.className='notification-empty'; div.textContent='Nenhuma notificação'; notificationList.appendChild(div); return;
  }
  notifications.forEach(n=>{
    const item = document.createElement('div'); item.className='notification-item';
    item.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${escapeHtml(n.message)}</strong><div class="small">${n.date}</div></div></div>`;
    notificationList.appendChild(item);
  });
}

function sendBrowserNotification(title, message){
  if(!("Notification" in window)) return;
  if(Notification.permission === "granted"){
    new Notification(title, { body: message, icon: '/favicon.ico', tag:'certificate-notification' });
  } else if(Notification.permission !== "denied"){
    Notification.requestPermission().then(p=>{
      if(p==='granted') new Notification(title, { body: message, icon: '/favicon.ico', tag:'certificate-notification' });
    });
  }
}

/* ---------- Service Worker (blob) ---------- */
function initServiceWorker(){
  if('serviceWorker' in navigator && 'PushManager' in window){
    const swCode = `
      self.addEventListener('install', e=>{ self.skipWaiting(); console.log('sw installed'); });
      self.addEventListener('activate', e=>{ console.log('sw activated'); });
      self.addEventListener('push', e=>{
        const data = e.data ? e.data.text() : 'Notificação do sistema';
        const options = { body: data, icon:'/favicon.ico', badge:'/favicon.ico' };
        e.waitUntil(self.registration.showNotification('Gerenciador de Certificados', options));
      });
    `;
    const blob = new Blob([swCode], { type: 'application/javascript' });
    const swURL = URL.createObjectURL(blob);
    navigator.serviceWorker.register(swURL).then(reg=>{
      serviceWorkerRegistration = reg;
      serviceWorkerStatus.textContent = 'Service Worker: Ativo';
      serviceWorkerStatus.className = 'service-worker-status status-active';
    }).catch(err=>{
      console.warn('SW failed', err);
      serviceWorkerStatus.textContent = 'Service Worker: Falha';
      serviceWorkerStatus.className = 'service-worker-status status-inactive';
    });
  } else {
    serviceWorkerStatus.textContent = 'Service Worker: Não suportado';
    serviceWorkerStatus.className = 'service-worker-status status-inactive';
  }
}

/* ---------- Eventos UI ---------- */
function attachEventListeners(){
  notificationIcon.addEventListener('click', e=>{
    const visible = notificationPanel.style.display === 'block';
    notificationPanel.style.display = visible ? 'none' : 'block';
  });
  clearNotificationsBtn.addEventListener('click', ()=>{ notifications = []; localStorage.setItem('notifications','[]'); renderNotifications(); });
  addCertificateBtn.addEventListener('click', ()=> uploadModal.style.display = 'flex');
  closeUploadModal.addEventListener('click', ()=>uploadModal.style.display='none');
  cancelUploadBtn.addEventListener('click', ()=>uploadModal.style.display='none');
  certificateUpload.addEventListener('click', ()=>certificateFile.click());
  certificateFile.addEventListener('change', async (e)=>{
    if(e.target.files.length > 0){
      const file = e.target.files[0];
      certificateUpload.innerHTML = `<div class="upload-icon"><i class="fas fa-spinner fa-spin"></i></div><p>Lendo certificado...</p>`;
      try {
        const certificateData = await readCertificateFile(file);
        uploadModal.style.display='none';
        showCertificateInfo(certificateData, file);
      } catch(err){
        alert('Erro ao ler o arquivo: ' + err.message);
        resetUploadArea();
      }
    }
  });
  closeInfoModal.addEventListener('click', ()=> certificateInfoModal.style.display='none');
  cancelInfoBtn.addEventListener('click', ()=> certificateInfoModal.style.display='none');
  closeDeleteModal.addEventListener('click', ()=> deleteModal.style.display='none');
  cancelDeleteBtn.addEventListener('click', ()=> deleteModal.style.display='none');
  confirmDeleteBtn.addEventListener('click', deleteCertificate);
  applyFilters.addEventListener('click', ()=>{ currentPage=1; renderCurrentPage(); });
  searchBtn.addEventListener('click', ()=>{ currentPage=1; renderCurrentPage(); });
  selectAll.addEventListener('change', e=>{ document.querySelectorAll('.certificate-checkbox').forEach(cb=> cb.checked = e.target.checked); });
  browserNotifications.addEventListener('change', saveNotificationSettings);
  systemNotifications.addEventListener('change', saveNotificationSettings);
  notificationDays.addEventListener('change', saveNotificationSettings);
  testNotificationBtn.addEventListener('click', ()=>{ if(notificationSettings.browserNotifications) sendBrowserNotification('Teste', 'Esta é uma notificação de teste.'); else alert('Ative notificações do navegador primeiro.'); });
  pageSizeSelect.addEventListener('change', ()=>{ pageSize = parseInt(pageSizeSelect.value); localStorage.setItem('pageSize', String(pageSize)); currentPage = 1; renderCurrentPage(); });
  document.addEventListener('click', (e)=>{ if(!notificationIcon.contains(e.target) && !notificationPanel.contains(e.target)) notificationPanel.style.display = 'none'; });

  certificateForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    const name = document.getElementById('certificateName').value.trim();
    const cnpjCpfRaw = document.getElementById('certificateCnpjCpf').value.trim();
    const uf = document.getElementById('certificateUf').value;
    const expiry = document.getElementById('certificateExpiry').value;
    const normalized = onlyDigits(cnpjCpfRaw);
    if(!(isValidCpf(normalized) || isValidCnpj(normalized))){
      alert('CNPJ/CPF inválido.');
      return;
    }
    if(currentCertificate && currentCertificate.id){
      const idx = certificatesData.findIndex(c => c.id === currentCertificate.id);
      if(idx!==-1){
        certificatesData[idx] = {...certificatesData[idx], name, cnpjCpf: normalized, uf, expiry, lastUpdate: new Date().toLocaleString('pt-BR')};
      }
    } else {
      const newId = certificatesData.length>0 ? Math.max(...certificatesData.map(c=>c.id))+1 : 1;
      certificatesData.push({ id: newId, name, cnpjCpf: normalized, uf, expiry, status: 'no-prazo', nightQuery: 'Desativada', manifest: 'Não', fileTypes: 'NFe/CTe', outputConfig: 'Não', lastUpdate: new Date().toLocaleString('pt-BR'), fileData: currentFile ? URL.createObjectURL(currentFile) : null });
    }
    localStorage.setItem('certificates', JSON.stringify(certificatesData));
    certificateInfoModal.style.display='none';
    currentCertificate = null; currentFile = null;
    alert('Certificado salvo com sucesso!');
    checkExpiryDates(); renderCurrentPage();
  });

  // Export / Import
  exportExcelBtn.addEventListener('click', exportFilteredToExcel);
  importBatchBtn.addEventListener('click', importBatchCertificates);

  // simple input mask for CPF/CNPJ display while typing
  document.addEventListener('input', (e)=>{
    if(e.target && e.target.id === 'certificateCnpjCpf'){
      const raw = onlyDigits(e.target.value);
      e.target.value = formatCnpjCpfDisplay(raw);
    }
  });
}

/* ---------- Operações sobre certificados ---------- */
function showCertificateInfo(certificateData, file){
  currentCertificate = certificateData && certificateData.id ? certificateData : null;
  currentFile = file || null;
  certificateInfo.innerHTML = `<h4>Informações Lidas</h4><div style="margin-bottom:8px">${certificateData.name || 'Não identificado'}</div><div class="small">Tipo: A1 (simulado)</div>`;
  document.getElementById('certificateName').value = certificateData.name || '';
  document.getElementById('certificateCnpjCpf').value = certificateData.cnpjCpf ? formatCnpjCpfDisplay(certificateData.cnpjCpf) : '';
  document.getElementById('certificateUf').value = certificateData.uf || '';
  document.getElementById('certificateExpiry').value = certificateData.expiry || '';
  certificateInfoModal.style.display = 'flex';
}
function editCertificate(id){ const certificate = certificatesData.find(c=>c.id===id); if(!certificate) return; currentCertificate = certificate; showCertificateInfo(certificate, null); }
function showDeleteModal(id){ const certificate = certificatesData.find(c=>c.id===id); if(!certificate) return; currentCertificate = certificate; deleteCertificateName.textContent = certificate.name; deleteModal.style.display = 'flex'; }
function deleteCertificate(){ if(!currentCertificate) return; certificatesData = certificatesData.filter(c=> c.id !== currentCertificate.id); localStorage.setItem('certificates', JSON.stringify(certificatesData)); deleteModal.style.display = 'none'; currentCertificate = null; checkExpiryDates(); renderCurrentPage(); }
function downloadCertificate(id){ const certificate = certificatesData.find(c=>c.id===id); if(certificate && certificate.fileData){ const link = document.createElement('a'); link.href = certificate.fileData; link.download = `certificate-${certificate.name}.p12`; document.body.appendChild(link); link.click(); document.body.removeChild(link); } else alert('Arquivo não disponível para download.'); }
function resetUploadArea(){ certificateUpload.innerHTML = `<div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div><p>Clique ou arraste o arquivo (.pfx .p12 .cer .crt .pem)</p>`; }

/* ---------- Simulated file read (improvise: tenta extrair números do filename) ---------- */
async function readCertificateFile(file){
  // NOTE: leitura real de p12/pfx necessita senha e libs (server-side). Aqui fazemos heurística:
  return new Promise((resolve, reject)=>{
    setTimeout(()=>{
      try {
        const fileName = file.name.replace(/\.[^/.]+$/, "");
        // tenta extrair números no filename (cpf/cnpj)
        const digitsFound = (fileName.match(/\d+/g) || []).join('');
        let cnpjCpf = '';
        if(digitsFound.length >= 11){
          // prefer 11 (CPF) if appears
          if(digitsFound.length === 11) cnpjCpf = digitsFound;
          else if(digitsFound.length === 14) cnpjCpf = digitsFound;
          else {
            // tenta pegar últimos 11 ou 14
            cnpjCpf = digitsFound.length >= 14 ? digitsFound.slice(-14) : digitsFound.slice(-11);
          }
        } else {
          // fallback: gera random (como antes) but mark as unknown
          cnpjCpf = generateRandomCnpj();
        }
        const certificateData = {
          id: null,
          name: fileName,
          cnpjCpf,
          uf: getRandomUF(),
          expiry: getRandomFutureDate(),
          status: "no-prazo",
          nightQuery: "Desativada",
          manifest: "Não",
          fileTypes: "NFe/CTe",
          outputConfig: "Não",
          lastUpdate: new Date().toLocaleString('pt-BR'),
          fileData: URL.createObjectURL(file)
        };
        resolve(certificateData);
      } catch(err){ reject(err); }
    }, 700);
  });
}

/* ---------- Export to Excel (SheetJS) ---------- */
function exportFilteredToExcel(){
  const filtered = applyCurrentFiltersTo(certificatesData);
  if(filtered.length === 0){ alert('Nenhum certificado para exportar.'); return; }
  const rows = filtered.map(c => ({
    Nome: c.name,
    CPF_CNPJ: formatCnpjCpfDisplay(c.cnpjCpf),
    UF: c.uf || '',
    Vencimento: formatDate(c.expiry),
    Status: c.status === 'no-prazo' ? 'No Prazo' : c.status === 'a-vencer' ? 'À Vencer' : 'Vencido',
    UltimaAtualizacao: c.lastUpdate || ''
  }));
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Certificados");
  XLSX.writeFile(wb, "certificados_filtrados.xlsx");
}

/* ---------- Importação em lote (pasta) ---------- */
async function importBatchCertificates(){
  // Suporta: showDirectoryPicker (Chrome/Edge), ou fallback para input[webkitdirectory]
  try {
    let files = [];
    if(window.showDirectoryPicker){
      const dirHandle = await window.showDirectoryPicker();
      files = await gatherFilesFromDirectoryHandle(dirHandle);
    } else {
      // fallback: criar input temporário com webkitdirectory
      files = await gatherFilesFromInputDirectoryFallback();
    }
    if(files.length === 0){ alert('Nenhum arquivo encontrado na pasta selecionada.'); return; }
    // filtrar por extensões
    const allowed = ['.p12','.pfx','.cer','.crt','.pem'];
    const candidateFiles = files.filter(f => allowed.some(ext => f.name.toLowerCase().endsWith(ext)));
    if(candidateFiles.length === 0){ alert('Nenhum arquivo de certificado válido encontrado.'); return; }

    let imported = 0, total = candidateFiles.length;
    // percorre e tenta ler cada arquivo (simulado)
    for(const file of candidateFiles){
      try {
        const certData = await readCertificateFile(file);
        const digits = onlyDigits(certData.cnpjCpf || '');
        // importar apenas pessoa física (CPF -> 11 dígitos)
        if(digits.length === 11 && isValidCpf(digits)){
          const newId = certificatesData.length>0 ? Math.max(...certificatesData.map(c=>c.id))+1 : 1;
          certificatesData.push({
            id: newId,
            name: certData.name,
            cnpjCpf: digits,
            uf: certData.uf,
            expiry: certData.expiry,
            status: certData.status,
            nightQuery: certData.nightQuery,
            manifest: certData.manifest,
            fileTypes: certData.fileTypes,
            outputConfig: certData.outputConfig,
            lastUpdate: certData.lastUpdate,
            fileData: certData.fileData
          });
          imported++;
        }
      } catch(err){
        console.warn('Erro lendo arquivo', file.name, err);
      }
    }
    localStorage.setItem('certificates', JSON.stringify(certificatesData));
    checkExpiryDates();
    renderCurrentPage();
    alert(`Importação finalizada. ${imported} certificados de pessoa física importados (de ${total} arquivos processados).`);
  } catch(err){
    console.error('Importação em lote falhou', err);
    alert('Erro durante a importação em lote. Verifique permissões do navegador.');
  }
}

/* Recursive gather files using DirectoryHandle (File System Access API) */
async function gatherFilesFromDirectoryHandle(dirHandle){
  const files = [];
  for await (const [, entry] of dirHandle.entries()){
    if(entry.kind === 'file'){
      const file = await entry.getFile();
      files.push(file);
    } else if(entry.kind === 'directory'){
      const nested = await gatherFilesFromDirectoryHandle(entry);
      files.push(...nested);
    }
  }
  return files;
}

/* Fallback: input[webkitdirectory] */
function gatherFilesFromInputDirectoryFallback(){
  return new Promise((resolve)=>{
    const input = document.createElement('input');
    input.type = 'file';
    input.webkitdirectory = true;
    input.multiple = true;
    input.style.display = 'none';
    document.body.appendChild(input);
    input.addEventListener('change', (e)=>{
      const files = Array.from(e.target.files || []);
      document.body.removeChild(input);
      resolve(files);
    });
    input.click();
  });
}

/* ---------- Utilitários ---------- */
function formatDate(dateString){
  if(!dateString) return '';
  const d = new Date(dateString);
  if(isNaN(d)) return dateString;
  const day = String(d.getDate()).padStart(2,'0');
  const month = String(d.getMonth()+1).padStart(2,'0');
  const year = d.getFullYear();
  return `${day}/${month}/${year}`;
}
function formatDateISO(date){ return formatDate(date.toISOString().split('T')[0]); }
function escapeHtml(str){ if(!str) return ''; return String(str).replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s])); }
function onlyDigits(str){ return String(str||'').replace(/\D/g,''); }
function formatCnpjCpfDisplay(raw){ if(!raw) return ''; const d = onlyDigits(raw); if(d.length===11) return d.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/,'$1.$2.$3-$4'); if(d.length===14) return d.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/,'$1.$2.$3/$4-$5'); return raw; }
function isValidCpf(digits){ if(!digits) return false; digits = onlyDigits(digits); if(digits.length!==11) return false; if(/^(\d)\1+$/.test(digits)) return false; let sum=0, rem; for(let i=1;i<=9;i++) sum += parseInt(digits.substring(i-1,i)) * (11 - i); rem=(sum*10)%11; if(rem===10) rem=0; if(rem !== parseInt(digits.substring(9,10))) return false; sum=0; for(let i=1;i<=10;i++) sum += parseInt(digits.substring(i-1,i)) * (12 - i); rem=(sum*10)%11; if(rem===10) rem=0; if(rem !== parseInt(digits.substring(10,11))) return false; return true;}
function isValidCnpj(cnpj){ if(!cnpj) return false; cnpj = onlyDigits(cnpj); if(cnpj.length!==14) return false; if(/^(\d)\1+$/.test(cnpj)) return false; const t = cnpj.length - 2, d = cnpj.substring(t), calc = (x)=>{ let n = cnpj.substring(0,x), y = x - 7, s = 0, r; for(let i = x; i>=1; i--) s += n.charAt(x - i) * y--, y = y < 2 ? 9 : y; r = 11 - s % 11; return r > 9 ? 0 : r; }; return calc(12) == d.charAt(0) && calc(13) == d.charAt(1); }
function generateRandomCnpj(){ let s=''; for(let i=0;i<14;i++) s+=Math.floor(Math.random()*10); return s; }
function getRandomUF(){ const ufs=['AC','AL','AM','AP','BA','CE','DF','ES','GO','MA','MG','MS','MT','PA','PB','PE','PI','PR','RJ','RN','RO','RR','RS','SC','SE','SP','TO']; return ufs[Math.floor(Math.random()*ufs.length)]; }
function getRandomFutureDate(){ const today=new Date(),f=new Date(); f.setDate(today.getDate()+Math.floor(Math.random()*365)+30); return f.toISOString().split('T')[0]; }

/* ---------- Notificação settings ---------- */
function saveNotificationSettings(){ notificationSettings.browserNotifications = browserNotifications.checked; notificationSettings.systemNotifications = systemNotifications.checked; notificationSettings.notificationDays = notificationDays.value; localStorage.setItem('notificationSettings', JSON.stringify(notificationSettings)); if(notificationSettings.systemNotifications && Notification.permission === 'default') Notification.requestPermission(); }
function loadNotificationSettings(){ browserNotifications.checked = notificationSettings.browserNotifications; systemNotifications.checked = notificationSettings.systemNotifications; notificationDays.value = notificationSettings.notificationDays; }

/* ---------- Periodic checker ---------- */
function startNotificationChecker(){ setInterval(()=>{ checkExpiryDates(); }, 60*60*1000); }

/* Exports para botões onClick via HTML dinâmico */
window.editCertificate = editCertificate;
window.showDeleteModal = showDeleteModal;
window.downloadCertificate = downloadCertificate;
window.renderCurrentPage = renderCurrentPage;
window.filterCertificates = ()=>{ currentPage = 1; renderCurrentPage(); };

</script>
</body>
</html>
